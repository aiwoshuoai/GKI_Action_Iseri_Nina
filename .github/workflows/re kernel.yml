name: Build GKI A14-6.1

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      tag_selection:
        description: "选择内核版本 (KMI 6.1 子版本 | 补丁日期)"
        required: true
        type: choice
        options:
          - "6.1.157 | 2025-12"
          - "6.1.145 | 2025-09"
          - "6.1.145 | 2025-08"
          - "6.1.141 | 2025-07"
          - "6.1.138 | 2025-06"
          - "6.1.134 | 2025-05"
          - "6.1.129 | 2025-04"
          - "6.1.128 | 2025-03"
          - "6.1.124 | 2025-02"
          - "6.1.118 | 2025-01"
          - "6.1.112 | 2024-12"
          - "6.1.X | lts"
          - "Manual Input"
        default: "6.1.157 | 2025-12"
      
      manual_version:
        description: "手动版本参数 (仅 Manual 模式生效, 格式: 6.1.157 2025-12 r1)"
        required: false
        type: string
      
      kernelsu_variant:
        description: "选择 KernelSU 变体"
        required: true
        type: choice
        options:
          - ReSukiSU
          - SukiSU
          - Official
          - MKSU
        default: ReSukiSU

      kernelsu_branch:
        description: "选择 ksu 分支"
        required: true
        type: choice
        options:
          - Stable(标准)
          - Dev(开发)
          - tmp-builtin
        default: Stable(标准)

      use_zram:
        description: '启用 ZRAM 增强 (lz4k/oplus)'
        required: true
        type: boolean
        default: true

      use_better_net:
        description: '启用网络功能增强 (BPF/IPSET/IPv6 NAT)'
        required: true
        type: boolean
        default: true

      cancel_susfs:
        description: '取消 SUSFS'
        required: true
        type: boolean
        default: false

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    env:
      ANDROID_VERSION: "android14"
      KERNEL_VERSION: "6.1"
      BETTER_NET: ${{ inputs.use_better_net }}

    steps:
      - name: 空间清理与环境准备
        uses: AdityaGarg8/remove-unwanted-software@v5
        with:
          remove-dotnet: 'true'
          remove-android: 'true'

      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: 解析 6.1 版本参数
        run: |
          SELECTION="${{ inputs.tag_selection }}"
          if [[ "$SELECTION" == "Manual Input" ]]; then
            INPUT="${{ inputs.manual_version }}"
            SUB_LEVEL=$(echo "$INPUT" | awk '{print $1}' | cut -d. -f3)
            OS_PATCH=$(echo "$INPUT" | awk '{print $2}')
            # 兼容手动输入中的修订号
            REV=$(echo "$INPUT" | awk '{print $3:-r1}')
          else
            # 提取 6.1.xxx 中的 xxx
            SUB_LEVEL=$(echo "$SELECTION" | awk -F' | ' '{print $1}' | cut -d. -f3)
            # 提取日期
            OS_PATCH=$(echo "$SELECTION" | cut -d'|' -f2 | xargs)
            REV="r1"
          fi
          
          # 处理 LTS 的特殊情况
          if [[ "$SUB_LEVEL" == "X" ]]; then
             MANIFEST_BRANCH="common-android14-6.1-lts"
          else
             # 如果补丁日期不是 lts，则构建标准分支名
             if [[ "$OS_PATCH" == "lts" ]]; then
                MANIFEST_BRANCH="common-android14-6.1-lts"
             else
                MANIFEST_BRANCH="common-android14-6.1-$OS_PATCH"
             fi
          fi

          echo "SUB_LEVEL=$SUB_LEVEL" >> $GITHUB_ENV
          echo "OS_PATCH_LEVEL=$OS_PATCH" >> $GITHUB_ENV
          echo "REVISION=$REV" >> $GITHUB_ENV
          echo "MANIFEST_BRANCH=$MANIFEST_BRANCH" >> $GITHUB_ENV
          echo "CONFIG=android14-6.1-$SUB_LEVEL" >> $GITHUB_ENV

      - name: 下载 Repo 工具与补丁库
        run: |
          mkdir -p ./git-repo
          curl https://storage.googleapis.com/git-repo-downloads/repo > ./git-repo/repo
          chmod a+rx ./git-repo/repo
          echo "REPO=$GITHUB_WORKSPACE/git-repo/repo" >> $GITHUB_ENV
          
          git clone https://github.com/WildPlusKernel/AnyKernel3.git -b "gki-2.0"
          git clone https://github.com/ShirkNeko/SukiSU_patch.git
          git clone https://github.com/zzh20188/GKI_KernelSU_SUSFS.git zzh_patch
          
          if [[ "${{ inputs.kernelsu_variant }}" == *"SukiSU"* ]]; then
            git clone https://github.com/ShirkNeko/susfs4ksu.git -b "gki-android14-6.1"
          else
            git clone https://gitlab.com/simonpunk/susfs4ksu.git -b "gki-android14-6.1"
          fi

      - name: 同步 Android 14 6.1 源码
        run: |
          mkdir -p "$CONFIG"
          cd "$CONFIG"
          # 使用解析出的分支同步
          echo "正在同步分支: ${{ env.MANIFEST_BRANCH }}"
          $REPO init --depth=1 -u https://android.googlesource.com/kernel/manifest -b ${{ env.MANIFEST_BRANCH }}
          $REPO sync -c -j$(nproc --all)

      - name: 注入 KernelSU
        run: |
          cd "$CONFIG"
          case "${{ inputs.kernelsu_variant }}" in
            "Official") URL="https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" ;;
            "ReSukiSU") URL="https://raw.githubusercontent.com/ReSukiSU/ReSukiSU/main/kernel/setup.sh" ;;
            "MKSU")     URL="https://raw.githubusercontent.com/5ec1cff/KernelSU/main/kernel/setup.sh" ;;
            "SukiSU")   URL="https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" ;;
          esac
          
          BR="${{ inputs.kernelsu_branch }}"
          if [ "$BR" == "tmp-builtin" ]; then ARG="-s tmp-builtin"; 
          elif [ "$BR" == "Stable(标准)" ]; then ARG="-s stable"; 
          else ARG="-s main"; fi
          
          curl -LSs "$URL" | bash -s $ARG

      - name: 注入 SUSFS (6.1 通用补丁)
        if: ${{ !inputs.cancel_susfs }}
        run: |
          cd "$CONFIG"
          cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch ./common/
          cp ../susfs4ksu/kernel_patches/fs/* ./common/fs/
          cp ../susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/
          cd common
          patch -p1 < 50_add_susfs_in_gki-android14-6.1.patch

      - name: 注入 ZRAM 增强补丁
        if: ${{ inputs.use_zram }}
        run: |
          cd "$CONFIG/common"
          cp -r ../../SukiSU_patch/other/zram/lz4k/include/linux/* ./include/linux/
          cp -r ../../SukiSU_patch/other/zram/lz4k/lib/* ./lib/
          cp -r ../../SukiSU_patch/other/zram/lz4k/crypto/* ./crypto/
          cp -r ../../SukiSU_patch/other/zram/lz4k_oplus ./lib/
          
          # 6.1 ZRAM 兼容性补丁
          if [ -f "../../zzh_patch/zram/6.1/lz4_1.10.0.patch" ]; then
            patch -p1 -F 3 < ../../zzh_patch/zram/6.1/lz4_1.10.0.patch || true
          fi

      - name: 配置 Defconfig (包含网络增强优化)
        run: |
          cd "$CONFIG"
          DEFCONFIG="common/arch/arm64/configs/gki_defconfig"
          
          echo "CONFIG_KSU=y" >> $DEFCONFIG
          if [ "${{ inputs.cancel_susfs }}" == "false" ]; then
             echo "CONFIG_KSU_SUSFS=y" >> $DEFCONFIG
             echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> $DEFCONFIG
             echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> $DEFCONFIG
          fi

          if [[ "${{ env.BETTER_NET }}" == "true" ]]; then
            echo "CONFIG_BPF_STREAM_PARSER=y" >> $DEFCONFIG
            echo "CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y" >> $DEFCONFIG
            echo "CONFIG_NETFILTER_XT_SET=y" >> $DEFCONFIG
            echo "CONFIG_IP_SET=y" >> $DEFCONFIG
            echo "CONFIG_IP_SET_MAX=65534" >> $DEFCONFIG
            echo "CONFIG_IP_SET_BITMAP_IP=y" >> $DEFCONFIG
            echo "CONFIG_IP_SET_BITMAP_IPMAC=y" >> $DEFCONFIG
            echo "CONFIG_IP_SET_BITMAP_PORT=y" >> $DEFCONFIG
            echo "CONFIG_IP_SET_HASH_IP=y" >> $DEFCONFIG
            echo "CONFIG_IP_SET_HASH_IPMARK=y" >> $DEFCONFIG
            echo "CONFIG_IP_SET_HASH_IPPORT=y" >> $DEFCONFIG
            echo "CONFIG_IP_SET_HASH_IPPORTIP=y" >> $DEFCONFIG
            echo "CONFIG_IP_SET_HASH_IPPORTNET=y" >> $DEFCONFIG
            echo "CONFIG_IP_SET_HASH_IPMAC=y" >> $DEFCONFIG
            echo "CONFIG_IP_SET_HASH_MAC=y" >> $DEFCONFIG
            echo "CONFIG_IP_SET_HASH_NETPORTNET=y" >> $DEFCONFIG
            echo "CONFIG_IP_SET_HASH_NET=y" >> $DEFCONFIG
            echo "CONFIG_IP_SET_HASH_NETNET=y" >> $DEFCONFIG
            echo "CONFIG_IP_SET_HASH_NETPORT=y" >> $DEFCONFIG
            echo "CONFIG_IP_SET_HASH_NETIFACE=y" >> $DEFCONFIG
            echo "CONFIG_IP_SET_LIST_SET=y" >> $DEFCONFIG
            echo "CONFIG_IP6_NF_NAT=y" >> $DEFCONFIG
            echo "CONFIG_IP6_NF_TARGET_MASQUERADE=y" >> $DEFCONFIG
            
            cd common
            wget https://github.com/cctv18/oppo_oplus_realme_sm8650/raw/refs/heads/main/other_patch/config.patch
            patch -p1 -F 3 < config.patch || true
            cd ..
          fi

          if [ "${{ inputs.use_zram }}" == "true" ]; then
             echo "CONFIG_ZSMALLOC=y" >> $DEFCONFIG
             echo "CONFIG_ZRAM=y" >> $DEFCONFIG
             echo "CONFIG_ZRAM_DEF_COMP_LZ4KD=y" >> $DEFCONFIG
             echo "CONFIG_CRYPTO_LZ4K=y" >> $DEFCONFIG
          fi
          
          sed -i 's/check_defconfig//g' common/build.config.gki*

      - name: 编译内核 (A14 6.1)
        run: |
          cd "$CONFIG"
          sed -i 's/BUILD_SYSTEM_DLKM=1/BUILD_SYSTEM_DLKM=0/' ./common/build.config.gki.aarch64
          LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh

      - name: 打包 AnyKernel3
        run: |
           cd AnyKernel3
           cp ../$CONFIG/out/android14-6.1/dist/Image ./
           ZIP_NAME="GKI-A14-6.1-${{ env.SUB_LEVEL }}-${{ env.OS_PATCH_LEVEL }}-${{ inputs.kernelsu_variant }}.zip"
           zip -r "$ZIP_NAME" ./*
           echo "ZIP_PATH=$GITHUB_WORKSPACE/AnyKernel3/$ZIP_NAME" >> $GITHUB_ENV

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: Kernel_A14_6.1_Output
          path: ${{ env.ZIP_PATH }}
